name: Claude Assist (@claude mentions)

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-assist:
    runs-on: ubuntu-latest
    # Only respond to @claude mentions
    if: contains(github.event.comment.body, '@claude')

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract request
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            // Remove @claude mention and trim
            const request = comment.replace(/@claude\b/gi, '').trim();
            core.setOutput('request', request);

            // Determine context type
            const isPR = context.payload.issue?.pull_request || context.payload.pull_request;
            core.setOutput('is_pr', isPR ? 'true' : 'false');

      - name: Claude Assist
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You've been mentioned in a GitHub comment. Help with the following request:

            **Request**: ${{ steps.extract.outputs.request }}

            **Context**:
            - Repository: ${{ github.repository }}
            - Is PR: ${{ steps.extract.outputs.is_pr }}
            - Comment author: ${{ github.event.comment.user.login }}

            Guidelines:
            1. Be helpful and concise
            2. If asked to write code, provide complete, working examples
            3. If asked to explain, be clear and educational
            4. If asked to review, focus on actionable feedback
            5. If the request is unclear, ask for clarification

            Respond directly to the user's request. Format your response for GitHub markdown.

          # Safe tools only
          allowed_tools: |
            Read,
            Grep,
            Glob,
            Bash(git log:*),
            Bash(git diff:*),
            Bash(npm list:*),
            WebSearch

          model: claude-sonnet-4-20250514
          max_tokens: 4096

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            // Add eyes reaction to acknowledge
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });
